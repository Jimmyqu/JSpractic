<!DOCTYPE html>
<!--[if lt IE 7]>      <html class="no-js lt-ie9 lt-ie8 lt-ie7"> <![endif]-->
<!--[if IE 7]>         <html class="no-js lt-ie9 lt-ie8"> <![endif]-->
<!--[if IE 8]>         <html class="no-js lt-ie9"> <![endif]-->
<!--[if gt IE 8]>      <html class="no-js"> <!--<![endif]-->
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <title></title>
    <meta name="description" content="" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link rel="stylesheet" href="" />
    <style>
      body {
        margin: 0;
        padding: 0;
      }
      #overlay {
        position: fixed;
        display: none;
        height: 100vh;
        width: 100vw;
        background-color: rgba(0, 0, 0, 0.5);
      }
      .canvas-wrapper {
        position: relative;
      }

      .float {
        position: absolute;
        top: 50px;
        left: 50px;
        overflow: hidden;
      }

      #canvas {
        position: absolute;
        top: 50px;
        left: 50px;
        display: inherit;
      }

      #circle {
        width: 200px;
        height: 200px;
        border-radius: 50%;
        border: 1000px solid rgba(0, 0, 0, .35);
        top: -1000px;
        left: -1000px;
        position: fixed;
        pointer-events:none;
      }

      #btns {
        position: fixed;
        bottom: 100px;
      }

      #canvas2 {
        position: fixed;
        bottom: 300px;
      }
    </style>
  </head>
  <body>
    <div id="overlay">
      <div class="canvas-wrapper">
        <canvas id="canvas"></canvas>
        <div class="float">
          <div id="circle"></div>
        </div>
      </div>

      <canvas id="canvas2" width="200" height="200"></canvas>
      <div id="btns">
        <button>截图</button>
      </div>
    </div>
    <div>
      <label
            class="btn"
            for="singleUploader"
            >选择照片
          </label>
          <input
            id="singleUploader"
            type="file"
            style="position: absolute; clip: rect(0 0 0 0)"
            accept="image/png, image/jpeg, image/gif, image/jpg"
          />
    </div>
    <script>
      window.onload = () => {
        let scale = 1;
        const singleUploader = document.querySelector('#singleUploader')
        const overlay = document.querySelector('#overlay')
        const float = document.querySelector('.float')
        const circle = document.querySelector('#circle')
        
        const canvas = document.querySelector('#canvas')
        const canvas2= document.querySelector('#canvas2')

        const ctx = canvas.getContext("2d")
        const ctx2 = canvas2.getContext("2d")
        var img = new Image();
        

        singleUploader.addEventListener('change', (e) => {
          const file = e.target.files[0];
          if (!/\.(gif|jpg|jpeg|png|bmp|GIF|JPG|PNG)$/.test(e.target.value)) {
            alert('图片类型必须是.gif,jpeg,jpg,png,bmp中的一种');
            return false;
          }
          console.log(file);
          const reader = new FileReader();
          reader.addEventListener('load', e1 => {
            const data =
              typeof e1.target.result === 'object'
                ? window.URL.createObjectURL(new Blob([e1.target.result]))
                : e1.target.result;
            
            img.onload = function(){
              const sclac = img.width/img.height
              canvas.width = (window.innerWidth || document.documentElement.clientWidth || document.body.clientWidth) - 100
              canvas.height = canvas.width / sclac
              ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
              overlay.style.display = 'block'
              float.style.width = `${canvas.width}px`
              float.style.height = `${canvas.height}px`
              circle.style.left = `-${1000 + 50 - canvas.width / 2}px`
              circle.style.top = `-${1000 + 50 - canvas.height / 2}px`
            }
            img.src= data
          });
          reader.readAsArrayBuffer(file);
        })

        float.addEventListener('touchstart', ev => {
          // 算出鼠标相对元素的位置
            const touch = (ev.targetTouches || ev.originalEvent.targetTouches)[0];
            const disX = touch.clientX - float.offsetLeft;
            const disY = touch.clientY - float.offsetTop;
            const [rangX, rangEX] = [parseInt(circle.style.left) + 1000, parseInt(circle.style.left) + 1000 - canvas.width + 200]
            const [rangY, rangEY] = [parseInt(circle.style.top) + 1000, parseInt(circle.style.top) + 1000 - canvas.height + 200]
            const touchmove = e2 => {
              if (e2.touches.length === 1) {
                e2.preventDefault();
                // 用鼠标的位置减去鼠标相对元素的位置，得到元素的位置
                const touch2 = (e2.targetTouches || e2.originalEvent.targetTouches)[0];
                const left = touch2.clientX - disX;
                const top = touch2.clientY - disY;

                if(left > rangX || top > rangY || left < rangEX || top < rangEY) {
                  return
                }
                float.style.left = left + 'px';
                float.style.top = top + 'px';

                canvas.style.left = left + 'px';
                canvas.style.top = top + 'px';

                ctx2.drawImage(img, left - canvas.width/2 + 50, top - canvas.height/2 +50 , canvas.width, canvas.height);
              }
            };
            document.addEventListener('touchmove', touchmove, { passive: false });
            const documentTouchend = () => {
              document.removeEventListener('touchmove', touchmove);
              document.removeEventListener('touchend', documentTouchend);
            };
            document.addEventListener('touchend', documentTouchend);
        })

        // TODO 有个全局对象保存 移动 scale 信息
        float.addEventListener('wheel', e => {
          scale = scale + (e.deltaY > 0 ? -0.1 : 0.1);
          console.log(scale)
          ctx.clearRect(0, 0, canvas.width, canvas.height)
          ctx.drawImage(img, 0, 0, canvas.width*scale, canvas.height*scale, 0, 0,  canvas.width, canvas.height)
          ctx2.drawImage(img, canvas.width/2 - 50, canvas.height/2 - 50 , (canvas.width/2 + 50)*img.width/img.height*scale, (canvas.height/2 + 50)*img.width/img.height*scale, 0, 0,canvas.width, canvas.height);

          // scale + (e.deltaY > 0 ? -0.2 : 0.2)
        })
      }
    </script>
  </body>
</html>
