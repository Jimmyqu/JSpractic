<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>Title</title>
    <link
      href="https://unpkg.com/tailwindcss@^2/dist/tailwind.min.css"
      rel="stylesheet"
    />
    <style>
      .box {
        width: 100px;
        height: 50px;
        top:10px;
        left: 10px;
        background-color: red;
        position: absolute;
      }
      .h-96 {
        position: relative;
      }
    </style>
  </head>
  <body>
    <h4>test</h4>
    <div class="flex container">
      <div class="w-8/12 bg-green-100 h-96">
        <div class="box"></div>
      </div>
    </div>
    <script>
      class EnvetBus {
        constructor() {
          this.events = {};
        }

        on(type, callback) {
          if(!this.events[type]){
            this.events[type] =[]
          }
          this.events[type].push(callback)
        }

        emit(type,...rags) {
          this.events[type].map(callback =>{
            callback(...rags)
          })
        }
      }

      class Dragify {
        constructor(el) {
          this.el = el;
          this.envirment = this.isTouch()
            ? ["touchstart", "touchmove", "touchend"]
            : ["mousedown", "mousemove", "mouseup"];
          this.init();
          this.watcher = new EnvetBus();
        }

        init() {
          this.el.addEventListener(this.envirment[0], (e) => {
            const event = this._getEventInfo(e);
            const parent = this.el.offsetParent;
            const pX = parent.offsetLeft;
            const pY = parent.offsetTop;
            const pWidth= parent.offsetWidth;
            const pHeight = parent.offsetHeight;
            const boxWidth = this.el.offsetWidth;
            const boxHeight = this.el.offsetHeight;
            const startX = this.el.offsetLeft;
            const startY = this.el.offsetTop;
            // console.log(event.clientX, event.clientY); // 指针相对于屏幕
            // console.log(this.el.offsetParent); //offsetParent 很有用，因为 offsetTop 和 offsetLeft 都是相对于其内边距边界的 
            // console.log(this.el.offsetLeft, this.el.offsetTop);
            this.watcher.emit('start', this.el)
            const foo = (e) =>{
              this.watcher.emit('move')
              const documentEvent = this._getEventInfo(e);
              const moveX = documentEvent.clientX - event.clientX
              const moveY = documentEvent.clientY - event.clientY
              this.el.style.left = startX + moveX + 'px'
              this.el.style.top = startY + moveY + 'px'
              if(this.el.offsetLeft < 0) {
                this.el.style.left = 0 + 'px'
              }
              if(this.el.offsetTop < 0) {
                this.el.style.top = 0 + 'px'
              }
              if(this.el.offsetLeft > pX+pWidth-boxWidth) {
                this.el.style.left = pX+pWidth-boxWidth + 'px'
              }
              if(this.el.offsetTop > pHeight-boxHeight) {
                this.el.style.top = pHeight-boxHeight + 'px'
              }
            }
            document.addEventListener(this.envirment[1], foo);
            const goo = ()=>{

              document.removeEventListener(this.envirment[1], foo)
              document.removeEventListener(this.envirment[2], goo)
            }
            document.addEventListener(this.envirment[2], goo);
          });
        }


        on() {
          this.watcher.on.apply(this.watcher, arguments)
        }

        isTouch(e) {
          return (
            "ontouchstart" in window ||
            (window.DocumentTouch &&
              document instanceof window.DocumentTouch) ||
            navigator.maxTouchPoints > 0 ||
            window.navigator.msMaxTouchPoints > 0
          );
        }

        _getEventInfo(e) {
          return this.isTouch() ? e.targetTouches[0] : e;
        }
      }

      const box = new Dragify(document.querySelector(".box"));
      box.on("start", (e) => {
        console.log("start", e);
      });

      box.on("move", () => {
        console.log("move");
      });
    </script>
  </body>
</html>
